<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agentic Workflow</title>
    <!-- Restore original CSS links -->
    <link rel="stylesheet" href="/static/base.css">
    <link rel="stylesheet" href="/static/header.css">
    <link rel="stylesheet" href="/static/analyzer-form.css">
    <link rel="stylesheet" href="/static/results.css">
    <link rel="stylesheet" href="/static/footer.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* Additional styles for new elements if needed, keeping original CSS */
        .results-card pre { background-color: rgba(5, 15, 30, 0.6); padding: 10px; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; font-family: 'JetBrains Mono', monospace; font-size: 0.9em; color: #e6edf3; }
        #analysisStatus .status-message { margin-bottom: 5px; padding: 5px; border-radius: 3px; }
        #analysisStatus .status-message.error { color: #D8000C; background-color: rgba(216, 0, 12, 0.2); border: 1px solid #D8000C; }
        #analysisStatus .status-message.info { color: #00529B; background-color: rgba(0, 82, 155, 0.2); border: 1px solid #00529B; }
        .no-selectors-message { color: #e6edf3; opacity: 0.8; font-style: italic; text-align: center; padding: 20px; }
        
        /* Updated selector styles to match site theme */
        .selector-list { 
            list-style: none; 
            padding: 0; 
            margin: 0;
        }
        .selector-item { 
            margin-bottom: 15px; 
            padding: 12px; 
            border-radius: 8px;
            background: rgba(10, 25, 50, 0.7);
            border: 1px solid rgba(99, 164, 255, 0.2);
            transition: all 0.2s ease;
        }
        .selector-item:hover { 
            border-color: rgba(99, 164, 255, 0.4);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        .selector-item span { 
            display: block; 
            margin-bottom: 8px; 
            color: #e6edf3;
        }
        .selector-desc { 
            font-weight: bold; 
            color: #4c8bf5 !important;
            font-size: 1.05em;
            padding-bottom: 6px;
            border-bottom: 1px solid rgba(99, 164, 255, 0.2);
            margin-bottom: 10px !important;
        }
        .selector-url { 
            font-size: 0.9em; 
            color: rgba(230, 237, 243, 0.7) !important;
            font-style: italic;
        }
        .selector-code { 
            font-family: 'JetBrains Mono', monospace; 
            background-color: rgba(5, 15, 30, 0.6); 
            padding: 8px 12px; 
            border-radius: 6px; 
            border: 1px solid rgba(99, 164, 255, 0.15);
            color: #e6edf3;
            overflow-x: auto;
            display: block;
        }
        #runAnalysisBtn { margin-top: 15px; /* Add space above analysis button */ }
    </style>
</head>
<body>
    <div class="background-wrapper">
        <img src="/static/images/space-background.webp" alt="" class="background-image">
    </div>
    <div class="main-content">
        <!-- Standard Header -->
        <header class="app-header">
            <div class="logo-container">
                <div class="logo-icon"></div>
                <h1>Webspark</h1>
            </div>
            <nav class="nav-links">
                <a href="/" class="nav-link">Home</a>
                <a href="/agent" class="nav-link active">Agent</a> <!-- Set agent link as active -->
                <a href="#" class="nav-link">Docs</a>
                <a href="#" class="nav-link">About</a>
                <button class="theme-toggle" aria-label="Toggle dark/light mode">
                    <i class="fas fa-moon"></i>
                </button>
            </nav>
        </header>

        <!-- Phase 1: Agent Execution Section -->
        <section class="hero-section">
            <div class="hero-content-left">
                <h1 class="hero-title">Phase 1: Run Agent & Discover Interactions</h1>
                <p class="hero-subtitle">Enter a task for the AI agent to perform and discover interactive elements.</p>
                <div class="url-form">
                    <textarea id="taskPrompt" placeholder="e.g., Go to https://example.com and click 'Submit'" class="url-input" rows="3"></textarea>
                    <button id="runAgentBtn" class="analyze-button">Run Agent</button>
                </div>
                 <div id="agentStatus" style="margin-top: 10px;"></div>
                 
                 <!-- Live Agent Logs -->
                 <div id="agentLogsCard" class="results-card" style="display: none; margin-top: 15px; margin-bottom: 15px;">
                     <div class="card-header">
                         <h3><i class="fas fa-stream"></i> Live Agent Logs</h3>
                     </div>
                     <div class="card-body">
                         <pre id="agentLogsContent" style="max-height: 300px; overflow-y: auto; background-color: #1a1d21; color: #e6edf3; border: 1px solid #30363d; padding: 10px; border-radius: 6px; white-space: pre-wrap; word-wrap: break-word; font-family: 'JetBrains Mono', monospace; font-size: 0.9em;"></pre>
                     </div>
                 </div>
            </div>
        </section>

        <!-- Agent Results Section -->
        <section class="results-section" id="agentResultsSection" style="display: none;">
            <!-- Discovered Selectors Card -->
            <div class="results-card" id="extractedSelectorsCard" style="display: none;">
                <div class="card-header">
                    <h2><i class="fas fa-search-location"></i> Discovered Selectors</h2>
                </div>
                <div class="card-body">
                    <div id="selectorsContent"></div> <!-- Selectors list will be rendered here -->
                </div>
            </div>
        </section>

        <!-- Phase 2: Agentic Tealium Analysis Section -->
        <section class="hero-section" id="analysisTriggerSection" style="display: none;">
             <div class="hero-content-left" style="border: 2px solid #4c8bf5; border-radius: 8px; padding: 20px; margin-top: 20px; background-color: rgba(20, 28, 58, 0.7);">
                <h2 class="hero-title">Phase 2: Analyze Discovered Interactions</h2>
                <p class="hero-subtitle">Click the button below to analyze the interactions found on the target URL for Tealium tags and events.</p>
                <p><strong>Target URL:</strong> <span id="analysisTargetUrl"></span></p>
                <button id="runAnalysisBtn" class="analyze-button" style="background-color: #4c8bf5; padding: 12px 24px; font-size: 1.1em;">Analyze Discovered Interactions</button>
             </div>
        </section>

        <!-- Analysis Results Section -->
        <section class="results-section" id="analysisResultsSection" style="display: none;">
            <!-- Analysis Progress Card -->
            <div class="results-card" id="analysisStatusCard">
                <div class="card-header">
                    <h2><i class="fas fa-tasks"></i> Analysis Progress</h2>
                </div>
                <div class="card-body">
                    <div id="analysisStatus"></div> <!-- Status messages will appear here -->
                </div>
            </div>
            <!-- Analysis Final Results Card -->
            <div class="results-card" id="analysisResultsCard" style="display: none;">
                <div class="card-header">
                    <h2><i class="fas fa-chart-bar"></i> Analysis Results</h2>
                </div>
                <div class="card-body">
                    <pre id="resultsContent"></pre> <!-- Formatted JSON results -->
                </div>
            </div>
        </section>

        <!-- Standard Footer -->
        <footer class="app-footer">
            <p>&copy; 2025 Webspark Tag Analyzer | All rights reserved</p>
        </footer>
    </div>

    <script>
        let targetUrl = null; // Variable to store the URL for Phase 2
        let eventSource = null; // Variable for SSE connection

        // --- Element References ---
        const taskPromptInput = document.getElementById('taskPrompt');
        const runAgentBtn = document.getElementById('runAgentBtn');
        const agentStatusDiv = document.getElementById('agentStatus'); // Status below input
        
        const agentResultsSection = document.getElementById('agentResultsSection');
        // History section is removed
        // const agentHistoryCard = document.getElementById('agentHistoryCard');
        // const historyContentDiv = document.getElementById('historyContent');
        const extractedSelectorsCard = document.getElementById('extractedSelectorsCard');
        const selectorsContentDiv = document.getElementById('selectorsContent');

        const analysisTriggerSection = document.getElementById('analysisTriggerSection');
        const analysisTargetUrlSpan = document.getElementById('analysisTargetUrl');
        const runAnalysisBtn = document.getElementById('runAnalysisBtn');

        const analysisResultsSection = document.getElementById('analysisResultsSection');
        const analysisStatusCard = document.getElementById('analysisStatusCard');
        const analysisStatusDiv = document.getElementById('analysisStatus'); // In the progress card
        const analysisResultsCard = document.getElementById('analysisResultsCard');
        const resultsContentPre = document.getElementById('resultsContent');

        // --- Phase 1: Agent Execution --- 
        runAgentBtn.addEventListener('click', runAgent);

        async function runAgent() {
            const task = taskPromptInput.value.trim();
            if (!task) {
                agentStatusDiv.innerHTML = '<p class="error">Please enter an agent task.</p>';
                return;
            }

            // Reset UI 
            agentStatusDiv.innerHTML = '<p>Agent running... <i class="fas fa-spinner fa-spin"></i></p>';
            
            // Show logs card and clear previous logs
            document.getElementById('agentLogsCard').style.display = 'block';
            const agentLogsContent = document.getElementById('agentLogsContent');
            agentLogsContent.innerHTML = 'Agent running... receiving logs...\n';
            
            // Reset other UI elements
            agentResultsSection.style.display = 'none';
            extractedSelectorsCard.style.display = 'none';
            selectorsContentDiv.innerHTML = '';
            analysisTriggerSection.style.display = 'none';
            analysisTargetUrlSpan.textContent = '';
            runAnalysisBtn.disabled = true;
            analysisResultsSection.style.display = 'none';
            analysisStatusDiv.innerHTML = ''; // Clear progress messages
            analysisResultsCard.style.display = 'none';
            resultsContentPre.textContent = '';
            targetUrl = null;
            
            // Close any existing event source
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }

            runAgentBtn.disabled = true;
            taskPromptInput.disabled = true;

            try {
                // Instead of using EventSource which would require a GET endpoint, we'll use the 
                // fetch streaming approach with our existing POST endpoint
                const response = await fetch('/stream-agent-run', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ task: task })
                });

                // Check if response is OK
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                // Set up reader for the response stream
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                
                // Process the stream
                while (true) {
                    const { done, value } = await reader.read();
                    
                    if (done) {
                        console.log('Stream complete.');
                        break;
                    }
                    
                    // Decode the chunk and add to buffer
                    buffer += decoder.decode(value, { stream: true });
                    
                    // Process complete messages (SSE format: data: {...}\n\n)
                    let dataIndex;
                    while ((dataIndex = buffer.indexOf('data: ')) >= 0) {
                        // Find the end of this data message
                        const messageEnd = buffer.indexOf('\n\n', dataIndex);
                        if (messageEnd === -1) break; // Incomplete message, wait for more data
                        
                        // Extract the JSON part (after 'data: ')
                        const jsonStr = buffer.substring(dataIndex + 6, messageEnd).trim();
                        buffer = buffer.substring(messageEnd + 2); // Remove processed message
                        
                        try {
                            const data = JSON.parse(jsonStr);
                            console.log('Received message:', data);
                            
                            if (data.status === 'log') {
                                // Append log message to the logs content
                                agentLogsContent.innerHTML += `${data.message}\n`;
                                // Auto-scroll to bottom
                                agentLogsContent.scrollTop = agentLogsContent.scrollHeight;
                            } 
                            else if (data.status === 'complete') {
                                agentLogsContent.innerHTML += `\nAgent execution complete.\n`;
                                
                                // Process results
                                const result = data.result;
                                agentStatusDiv.innerHTML = '<p style="color: green;">Agent run complete.</p>';
                                
                                // Show agent results section
                                agentResultsSection.style.display = 'block';
                                
                                // Always call renderSelectors to load existing or display 'none'
                                renderSelectors(result.extracted_selectors); // Pass potential new selectors
                                extractedSelectorsCard.style.display = 'block'; // Ensure card is visible

                                // Determine targetUrl from history regardless of extracted selectors
                                targetUrl = null; // Reset targetUrl
                                if (result.history && result.history.length > 0) {
                                    // Prioritize URL from the last step's state
                                    const lastStep = result.history[result.history.length - 1];
                                    if (lastStep.state && lastStep.state.url && lastStep.state.url !== 'about:blank') {
                                        targetUrl = lastStep.state.url;
                                    } else {
                                        // Fallback: Look for the first valid URL in history entries
                                        for (const entry of result.history) {
                                            if (entry.state && entry.state.url && entry.state.url !== 'about:blank') {
                                                targetUrl = entry.state.url;
                                                break;
                                            }
                                        }
                                    }
                                }

                                // Show Tealium analysis section if a target URL was found
                                if (targetUrl) {
                                    analysisTargetUrlSpan.textContent = targetUrl;
                                    analysisTriggerSection.style.display = 'block';
                                    runAnalysisBtn.disabled = false;
                                    agentStatusDiv.innerHTML += `<p style="color: #4c8bf5; font-weight: bold;">âœ… Ready for Phase 2: Click the 'Analyze Discovered Interactions' button below.</p>`;
                                    // Scroll to the analysis section
                                    setTimeout(() => {
                                        analysisTriggerSection.scrollIntoView({ behavior: 'smooth' });
                                    }, 500);
                                } else {
                                    // If no URL found, indicate Phase 2 isn't ready
                                    agentStatusDiv.innerHTML += '<p>No target URL found in history for Phase 2 analysis.</p>';
                                    analysisTriggerSection.style.display = 'none'; // Hide the button
                                }
                            }
                            else if (data.status === 'error') {
                                agentLogsContent.innerHTML += `\nERROR: ${data.message}\n`;
                                agentStatusDiv.innerHTML = `<p class="error">Agent Error: ${data.message}</p>`;
                                break;
                            }
                        } catch (e) {
                            console.error('Error parsing message:', e, 'Raw JSON:', jsonStr);
                            agentLogsContent.innerHTML += `\nError parsing message: ${e.message}\n`;
                        }
                    }
                }
            } catch (error) {
                console.error('Error running agent:', error);
                agentLogsContent.innerHTML += `\nERROR: ${error.message}\n`;
                agentStatusDiv.innerHTML = `<p class="error">Error during agent run: ${error.message}</p>`;
            } finally {
                runAgentBtn.disabled = false;
                taskPromptInput.disabled = false;
            }
            
            return false; // Prevent form submission
        }

        function renderHistory(history) {
             // Renders history into historyContentDiv (using list format)
             let html = '<ul>';
             
             history.forEach((step, index) => {
                 html += `<li style="list-style-type: none; padding-left: 0; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                            <strong>Step ${index + 1}: ${step.action || 'N/A'}</strong>`;
                 if (step.args) {
                      html += `<br>Args: <pre style="margin-top: 5px;">${JSON.stringify(step.args, null, 2)}</pre>`;
                 }
                  if (step.result) {
                      // Avoid excessively long results in history view
                      let resultStr = JSON.stringify(step.result, null, 2);
                      if (resultStr.length > 500) { 
                          resultStr = resultStr.substring(0, 500) + '... (truncated)'; 
                      }
                      html += `<br>Result: <pre style="margin-top: 5px;">${resultStr}</pre>`;
                  }
                  if (step.state && step.state.screenshot) {
                     const screenshotFilename = step.state.screenshot.split(/[\/]/).pop(); 
                     const screenshotUrl = `/screenshots/${screenshotFilename}`;
                     html += `<br><a href="${screenshotUrl}" target="_blank" style="margin-top: 5px; display: inline-block;">View Screenshot <i class="fas fa-external-link-alt"></i></a>`;
                  }
                 html += `</li>`;
             });
             html += '</ul>';
             historyContentDiv.innerHTML = html;
         }

        function renderSelectors(selectors) {
            // Renders selectors into selectorsContentDiv
            if (!selectors || selectors.length === 0) {
                // If no selectors provided, fetch them from agent_discovered_selectors.json
                fetch('/agent_discovered_selectors.json')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to load selectors');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data && data.length > 0) {
                            displaySelectors(data);
                            extractedSelectorsCard.style.display = 'block';
                        } else {
                            selectorsContentDiv.innerHTML = '<p class="no-selectors-message">No selectors were found in agent_discovered_selectors.json</p>';
                            extractedSelectorsCard.style.display = 'block';
                        }
                    })
                    .catch(error => {
                        console.error('Error loading selectors:', error);
                        selectorsContentDiv.innerHTML = '<p class="no-selectors-message">No selectors were extracted by the agent.</p>';
                        extractedSelectorsCard.style.display = 'block';
                    });
            } else {
                // If selectors are provided, use them
                displaySelectors(selectors);
            }
            
            function displaySelectors(selectorList) {
                let html = '<ul class="selector-list">';
                selectorList.forEach(sel => {
                    html += `<li class="selector-item">
                                <span class="selector-desc">${sel.description || 'Unnamed Selector'}</span>
                                <span class="selector-code">${sel.selector}</span>
                                <span class="selector-url">URL: ${sel.url || 'undefined'}</span>
                             </li>`;
                });
                html += '</ul>';
                selectorsContentDiv.innerHTML = html;
            }
        }

        // --- Phase 2: Agentic Analysis --- 
        runAnalysisBtn.addEventListener('click', runAnalysis);

        function runAnalysis() {
            if (!targetUrl) {
                alert('Error: Target URL not set. Run the agent first.');
                return;
            }

            // Close any existing connection
            if (eventSource) {
                eventSource.close();
            }

            runAnalysisBtn.disabled = true;
            analysisResultsSection.style.display = 'block'; // Show analysis results area
            analysisStatusCard.style.display = 'block'; // Ensure progress card is visible
            analysisStatusDiv.innerHTML = '<p class="status-message info">Starting analysis... <i class="fas fa-spinner fa-spin"></i></p>'; // Initial status in progress card
            analysisResultsCard.style.display = 'none'; // Hide final results card initially
            resultsContentPre.textContent = '';

            // Ensure we're using a valid URL
            if (!targetUrl.startsWith('http')) {
                targetUrl = 'https://' + targetUrl;
            }
            const analysisUrl = `/stream-agent-analysis?url=${encodeURIComponent(targetUrl)}`;
            eventSource = new EventSource(analysisUrl);
            
            // Show status message that analysis has started
            agentStatusDiv.innerHTML += '<p style="color: #4c8bf5;">Tealium analysis has started! See results below.</p>';

            eventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    console.log('SSE Received:', data);

                    if (data.status === 'progress') {
                        // Append progress messages to the status div
                        analysisStatusDiv.innerHTML += `<p class="status-message info">${data.message}</p>`;
                    } else if (data.status === 'complete') {
                        analysisStatusDiv.innerHTML += '<p class="status-message info" style="color: #4ade80; background-color: rgba(74, 222, 128, 0.1); border-color: #4ade80;">Analysis complete.</p>';
                        
                        // Call function to render styled results instead of raw JSON
                        renderAnalysisResults(data.results);
                        // resultsContentPre.textContent = JSON.stringify(data.results, null, 2);
                        analysisResultsCard.style.display = 'block'; // Show final results card
                        eventSource.close(); 
                        eventSource = null; 
                    } else if (data.status === 'error') {
                         analysisStatusDiv.innerHTML += `<p class="status-message error">Analysis Error: ${data.message}</p>`;
                         eventSource.close();
                         eventSource = null;
                         runAnalysisBtn.disabled = false; // Re-enable on error
                    }
                } catch (e) {
                    console.error("Error parsing SSE data:", e, "Raw data:", event.data);
                    analysisStatusDiv.innerHTML += `<p class="status-message error">Error processing update: ${e.message}</p>`;
                }
            };

            eventSource.onerror = function(error) {
                console.error('SSE Error:', error);
                analysisStatusDiv.innerHTML += '<p class="status-message error">Connection error during analysis.</p>';
                eventSource.close();
                eventSource = null;
                runAnalysisBtn.disabled = false; // Re-enable on connection error
            };
        }
        
        // --- Helper Function to Render Styled Analysis Results (Phase 2) ---
        function renderAnalysisResults(results) {
            if (!results) {
                resultsContentPre.innerHTML = '<p style="color: #f87171;">No analysis results received.</p>';
                return;
            }

            let html = '';

            // Basic Info
            html += `<h4 style="color: #e6edf3;">Analysis Summary for: ${results.url || 'N/A'}</h4>`;
            if (results.page_title) {
                 html += `<p style="color: #e6edf3;"><strong>Page Title:</strong> ${results.page_title}</p>`;
            }
            if (results.error) {
                 html += `<p style="color: #f87171;"><strong>Error during analysis:</strong> ${results.error}</p>`;
            }

            // Page Load Analysis
            if (results.pageLoadAnalysis) {
                html += `<div class="results-card" style="margin-top:15px;">`; // Nested card styling
                html += `<div class="card-header"><h5 style="color: #e6edf3;"><i class="fas fa-truck-loading" style="color: #4c8bf5;"></i> Page Load Analysis</h5></div>`;
                html += `<div class="card-body">`;
                const pl = results.pageLoadAnalysis;
                if (pl.vendorsDetected && pl.vendorsDetected.length > 0) {
                    html += `<h6 style="color: #4c8bf5;">Vendors Detected (${pl.vendorsDetected.length}):</h6><ul style="color: #e6edf3;">`;
                    pl.vendorsDetected.forEach(v => { html += `<li>${v}</li>`; });
                    html += `</ul>`;
                }
                 if (pl.initial_tealium_events && pl.initial_tealium_events.length > 0) {
                     html += `<h6 style="color: #4c8bf5;">Initial Tealium Events (${pl.initial_tealium_events.length}):</h6><pre style="background-color: rgba(5, 15, 30, 0.6); color: #e6edf3; padding: 8px; border-radius: 6px; border: 1px solid rgba(99, 164, 255, 0.15);">${JSON.stringify(pl.initial_tealium_events, null, 2)}</pre>`;
                 }
                 if (pl.initial_general_events && pl.initial_general_events.network) {
                     const networkEvents = pl.initial_general_events.network;
                     const totalRequests = networkEvents.length;
                     const tealiumRequests = networkEvents.filter(req => typeof req.url === 'string' && req.url.includes('tealium')).length;
                     console.log("Calculated Tealium Requests:", tealiumRequests);
                     
                      html += `<h6 style="color: #4c8bf5;">Network Summary:</h6>`;
                      html += `<ul style="color: #e6edf3;">
                                <li>Total Requests: ${totalRequests}</li>
                                <li>Tealium Requests: ${tealiumRequests}</li>
                              </ul>`;
                      
                      // Add network events table
                      html += `<h6 style="color: #4c8bf5;">Initial Network Events (${networkEvents.length > 10 ? '10 of ' + networkEvents.length : networkEvents.length}):</h6>`;
                      html += `<div style="max-height: 200px; overflow-y: auto;">`;
                      html += `<table style="width: 100%; color: #e6edf3; border-collapse: collapse;">`;
                      html += `<tr style="background-color: rgba(5, 15, 30, 0.6);"><th style="padding: 6px; text-align: left; border: 1px solid rgba(99, 164, 255, 0.15);">URL</th><th style="padding: 6px; text-align: left; border: 1px solid rgba(99, 164, 255, 0.15);">Method</th><th style="padding: 6px; text-align: left; border: 1px solid rgba(99, 164, 255, 0.15);">Type</th><th style="padding: 6px; text-align: left; border: 1px solid rgba(99, 164, 255, 0.15);">Timestamp</th></tr>`;
                      
                      // Only show first 10 to avoid overwhelming the display
                      const eventsToShow = networkEvents.slice(0, 10);
                      eventsToShow.forEach(n => {
                          html += `<tr style="border: 1px solid rgba(99, 164, 255, 0.15);">`;
                          html += `<td style="padding: 6px; border: 1px solid rgba(99, 164, 255, 0.15); word-break: break-all;"><span style="font-size: 0.9em;">${n.url}</span></td>`;
                          html += `<td style="padding: 6px; border: 1px solid rgba(99, 164, 255, 0.15);">${n.method}</td>`;
                          html += `<td style="padding: 6px; border: 1px solid rgba(99, 164, 255, 0.15);">${n.type}</td>`;
                          html += `<td style="padding: 6px; border: 1px solid rgba(99, 164, 255, 0.15);">${new Date(n.timestamp).toLocaleTimeString()}</td>`;
                          html += `</tr>`;
                      });
                      html += `</table>`;
                      html += `</div>`;
                 }
                 if (pl.errors && pl.errors.length > 0) {
                     html += `<h6 style="color: #4c8bf5;">Page Load Errors:</h6><ul>`;
                      pl.errors.forEach(e => { html += `<li style="color: #f87171;">${e}</li>`; });
                     html += `</ul>`;
                 }
                html += `</div></div>`;
            }

            // Agent Interaction Analysis
            if (results.agentInteractionAnalysis && results.agentInteractionAnalysis.length > 0) {
                html += `<h4 style="color: #e6edf3;"><i class="fas fa-mouse-pointer" style="color: #4c8bf5;"></i> Agent Interaction Analysis (${results.agentInteractionAnalysis.length})</h4>`;
                results.agentInteractionAnalysis.forEach((interaction, index) => {
                    html += `<div class="results-card" style="margin-top: 15px;">`; // Nested card styling
                    html += `<div class="card-header"><h5 style="color: #e6edf3;"><i class="fas fa-mouse-pointer" style="color: #4c8bf5;"></i> Interaction ${index + 1}: ${interaction.description || 'N/A'}</h5></div>`;
                    html += `<div class="card-body">`;
                    html += `<p style="color: #e6edf3;"><strong>Selector:</strong> <code style="background-color: rgba(5, 15, 30, 0.6); color: #e6edf3; padding: 4px 6px; border-radius: 4px; font-family: 'JetBrains Mono', monospace;">${interaction.selector || 'N/A'}</code></p>`;
                    html += `<p><strong>Status:</strong> ${interaction.status === 'Success' ? '<span style="color: #4ade80;">Success</span>' : '<span style="color: #f87171;">Failed</span>'}</p>`;
                    if (interaction.error) {
                         html += `<p style="color: #f87171;"><strong>Error:</strong> ${interaction.error}</p>`;
                    }
                    if (interaction.tealium_events && interaction.tealium_events.length > 0) {
                         html += `<h6 style="color: #4c8bf5;">Triggered Tealium Events (${interaction.tealium_events.length}):</h6><pre style="background-color: rgba(5, 15, 30, 0.6); color: #e6edf3; padding: 8px; border-radius: 6px; border: 1px solid rgba(99, 164, 255, 0.15);">${JSON.stringify(interaction.tealium_events, null, 2)}</pre>`;
                    }
                     if (interaction.vendors_in_network && Object.keys(interaction.vendors_in_network).length > 0) {
                          html += `<h6 style="color: #4c8bf5;">Vendors Called After Interaction (${Object.keys(interaction.vendors_in_network).length}):</h6><ul style="color: #e6edf3;">`;
                          Object.keys(interaction.vendors_in_network).forEach(v => { html += `<li>${v}</li>`; });
                          html += `</ul>`;
                      }
                      
                      if (interaction.general_events && interaction.general_events.network && interaction.general_events.network.length > 0) {
                          html += `<h6 style="color: #4c8bf5;">Network Events (${interaction.general_events.network.length}):</h6>`;
                          html += `<div style="max-height: 200px; overflow-y: auto;">`;
                          html += `<table style="width: 100%; color: #e6edf3; border-collapse: collapse;">`;
                          html += `<tr style="background-color: rgba(5, 15, 30, 0.6);"><th style="padding: 6px; text-align: left; border: 1px solid rgba(99, 164, 255, 0.15);">URL</th><th style="padding: 6px; text-align: left; border: 1px solid rgba(99, 164, 255, 0.15);">Method</th><th style="padding: 6px; text-align: left; border: 1px solid rgba(99, 164, 255, 0.15);">Type</th><th style="padding: 6px; text-align: left; border: 1px solid rgba(99, 164, 255, 0.15);">Timestamp</th></tr>`;
                          interaction.general_events.network.forEach(n => {
                              html += `<tr style="border: 1px solid rgba(99, 164, 255, 0.15);">`;
                              html += `<td style="padding: 6px; border: 1px solid rgba(99, 164, 255, 0.15); word-break: break-all;"><span style="font-size: 0.9em;">${n.url}</span></td>`;
                              html += `<td style="padding: 6px; border: 1px solid rgba(99, 164, 255, 0.15);">${n.method}</td>`;
                              html += `<td style="padding: 6px; border: 1px solid rgba(99, 164, 255, 0.15);">${n.type}</td>`;
                              html += `<td style="padding: 6px; border: 1px solid rgba(99, 164, 255, 0.15);">${new Date(n.timestamp).toLocaleTimeString()}</td>`;
                              html += `</tr>`;
                          });
                          html += `</table>`;
                          html += `</div>`;
                      }
                    html += `</div></div>`;
                });
            }

            // Replace content of the <pre> tag with formatted HTML
            resultsContentPre.innerHTML = html;
        }

        // Add theme toggle functionality (assuming it exists in base.css/scripts)
        const themeToggle = document.querySelector('.theme-toggle');
        if (themeToggle) {
            themeToggle.addEventListener('click', () => {
                document.body.classList.toggle('dark-theme');
                // Optional: Save theme preference to localStorage
                if (document.body.classList.contains('dark-theme')) {
                    localStorage.setItem('theme', 'dark');
                } else {
                    localStorage.setItem('theme', 'light');
                }
            });
        }
        // Optional: Load theme preference on page load
        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-theme');
        }

    </script>
</body>
</html>
