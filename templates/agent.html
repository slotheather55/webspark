<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agentic Workflow</title>
    <link rel="stylesheet" href="/static/base.css">
    <link rel="stylesheet" href="/static/header.css">
    <link rel="stylesheet" href="/static/analyzer-form.css">
    <link rel="stylesheet" href="/static/results.css"> <link rel="stylesheet" href="/static/footer.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* Styles from previous version (agent.html specific + results tabs) */
        .results-card pre { background-color: rgba(5, 15, 30, 0.6); padding: 10px; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; font-family: 'JetBrains Mono', monospace; font-size: 0.9em; color: #e6edf3; }
        #analysisStatus .status-message { margin-bottom: 5px; padding: 5px; border-radius: 3px; }
        #analysisStatus .status-message.error { color: #D8000C; background-color: rgba(216, 0, 12, 0.2); border: 1px solid #D8000C; }
        #analysisStatus .status-message.info { color: #00529B; background-color: rgba(0, 82, 155, 0.2); border: 1px solid #00529B; }
        .no-selectors-message { color: #e6edf3; opacity: 0.8; font-style: italic; text-align: center; padding: 20px; }
        .selector-list { list-style: none; padding: 0; margin: 0; }
        .selector-item { margin-bottom: 15px; padding: 12px; border-radius: 8px; background: rgba(10, 25, 50, 0.7); border: 1px solid rgba(99, 164, 255, 0.2); transition: all 0.2s ease; }
        .selector-item:hover { border-color: rgba(99, 164, 255, 0.4); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); }
        .selector-item span { display: block; margin-bottom: 8px; color: #e6edf3; }
        .selector-desc { font-weight: bold; color: #4c8bf5 !important; font-size: 1.05em; padding-bottom: 6px; border-bottom: 1px solid rgba(99, 164, 255, 0.2); margin-bottom: 10px !important; }
        .selector-url { font-size: 0.9em; color: rgba(230, 237, 243, 0.7) !important; font-style: italic; }
        .selector-code { font-family: 'JetBrains Mono', monospace; background-color: rgba(5, 15, 30, 0.6); padding: 8px 12px; border-radius: 6px; border: 1px solid rgba(99, 164, 255, 0.15); color: #e6edf3; overflow-x: auto; display: block; }
        #runAnalysisBtn { margin-top: 15px; }
        .results-tabs { display: flex; border-bottom: 1px solid rgba(99, 164, 255, 0.2); margin-bottom: 15px; }
        .tab-button { background: none; border: none; padding: 10px 15px; cursor: pointer; color: rgba(230, 237, 243, 0.7); font-size: 1em; border-bottom: 2px solid transparent; transition: all 0.2s ease; }
        .tab-button:hover { color: #e6edf3; }
        .tab-button.active { color: #4c8bf5; border-bottom-color: #4c8bf5; font-weight: 600; }
        .tab-content { /* No specific styles needed, children handle layout */ }
        .tab-pane { display: none; animation: fadeIn 0.3s ease; }
        .tab-pane.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .section-header { font-size: 1.1em; font-weight: 600; color: #e6edf3; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 1px solid rgba(99, 164, 255, 0.1); display: flex; align-items: center; }
        .section-header i { margin-right: 8px; color: #4c8bf5; }
        .event-table { width: 100%; border-collapse: collapse; margin-top: 10px; color: #e6edf3; background-color: rgba(5, 15, 30, 0.6); border: 1px solid rgba(99, 164, 255, 0.15); border-radius: 6px; overflow: hidden;}
        .event-table th, .event-table td { padding: 10px 12px; text-align: left; border-bottom: 1px solid rgba(99, 164, 255, 0.1); }
        .event-table th { background-color: rgba(10, 25, 50, 0.8); font-weight: 600; }
        .event-table tr:last-child td { border-bottom: none; }
        .event-table td code { background-color: rgba(5, 15, 30, 0.8); padding: 2px 5px; border-radius: 4px; font-family: 'JetBrains Mono', monospace;}
        .interaction-card { background: rgba(10, 25, 50, 0.7); border: 1px solid rgba(99, 164, 255, 0.2); border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .interaction-card h6 { color: #4c8bf5; margin-top: 0; margin-bottom: 10px; font-size: 1.05em; }
        .interaction-card p { margin-bottom: 8px; color: #e6edf3; font-size: 0.95em;}
        .interaction-card code { background-color: rgba(5, 15, 30, 0.8); padding: 2px 5px; border-radius: 4px; font-family: 'JetBrains Mono', monospace;}
        .interaction-card pre { max-height: 200px; overflow-y: auto; } /* Ensure preformatted text is scrollable */
        .download-container { margin-top: 20px; text-align: right; }
        .btn-secondary { /* Style based on index.html if needed */ }
        #visualization-area p, #visualization-area ul { color: #e6edf3; }
        #analysisResultsCard .card-body { padding-top: 0; /* Adjust padding if needed */ }
         /* Style for vendor lists */
        .vendor-category { text-transform: capitalize; color: #63a4ff; margin-top:10px; margin-bottom: 5px; font-weight: bold;}
        .vendor-list { list-style: disc; margin-left: 20px; color: #e6edf3; }
    </style>
</head>
<body>
    <div class="background-wrapper">
        <img src="/static/images/space-background.webp" alt="" class="background-image">
    </div>
    <div class="main-content">
        <header class="app-header">
            <div class="logo-container">
                <div class="logo-icon"></div>
                <h1>Webspark</h1>
            </div>
            <nav class="nav-links">
                <a href="/" class="nav-link">Home</a>
                <a href="/agent" class="nav-link active">Agent</a> <a href="#" class="nav-link">Docs</a>
                <a href="#" class="nav-link">About</a>
                <button class="theme-toggle" aria-label="Toggle dark/light mode">
                    <i class="fas fa-moon"></i>
                </button>
            </nav>
        </header>

        <section class="hero-section">
            <div class="hero-content-left">
                <h1 class="hero-title">Phase 1: Run Agent & Discover Interactions</h1>
                <p class="hero-subtitle">Enter a task for the AI agent to perform and discover interactive elements.</p>
                <div class="url-form">
                    <textarea id="taskPrompt" placeholder="e.g., Go to https://example.com and click 'Submit'" class="url-input" rows="3"></textarea>
                    <button id="runAgentBtn" class="analyze-button">Run Agent</button>
                </div>
                 <div id="agentStatus" style="margin-top: 10px;"></div>

                 <div id="agentLogsCard" class="results-card" style="display: none; margin-top: 15px; margin-bottom: 15px;">
                     <div class="card-header">
                         <h3><i class="fas fa-stream"></i> Live Agent Logs</h3>
                     </div>
                     <div class="card-body">
                         <pre id="agentLogsContent" style="max-height: 300px; overflow-y: auto; background-color: #1a1d21; color: #e6edf3; border: 1px solid #30363d; padding: 10px; border-radius: 6px; white-space: pre-wrap; word-wrap: break-word; font-family: 'JetBrains Mono', monospace; font-size: 0.9em;"></pre>
                     </div>
                 </div>
            </div>
        </section>

        <section class="results-section" id="agentResultsSection" style="display: none;">
            <div class="results-card" id="extractedSelectorsCard" style="display: none;">
                <div class="card-header">
                    <h2><i class="fas fa-search-location"></i> Discovered Selectors</h2>
                </div>
                <div class="card-body">
                    <div id="selectorsContent"></div> </div>
            </div>
        </section>

        <section class="hero-section" id="analysisTriggerSection" style="display: none;">
             <div class="hero-content-left" style="border: 2px solid #4c8bf5; border-radius: 8px; padding: 20px; margin-top: 20px; background-color: rgba(20, 28, 58, 0.7);">
                <h2 class="hero-title">Phase 2: Analyze Discovered Interactions</h2>
                <p class="hero-subtitle">Click the button below to analyze the interactions found on the target URL for Tealium tags and events.</p>
                <p><strong>Target URL:</strong> <span id="analysisTargetUrl"></span></p>
                <button id="runAnalysisBtn" class="analyze-button" style="background-color: #4c8bf5; padding: 12px 24px; font-size: 1.1em;">Analyze Discovered Interactions</button>
             </div>
        </section>

        <section class="results-section" id="analysisResultsSection" style="display: none;">
            <div class="results-card" id="analysisStatusCard">
                <div class="card-header">
                    <h2><i class="fas fa-tasks"></i> Analysis Progress</h2>
                </div>
                <div class="card-body">
                    <div id="analysisStatus"></div> </div>
            </div>

            <div class="results-card expandable" id="analysisResultsCard" style="display: none;">
                <div class="card-header toggle-expand"> <h2><i class="fas fa-chart-pie"></i> Analysis Results</h2>
                     <div class="card-controls">
                         <button id="copy-results-agent" class="btn-icon" title="Copy results (raw JSON)">
                            <i class="fas fa-copy"></i>
                        </button>
                        </div>
                </div>
                <div class="card-body">
                    <div id="results-container-agent" class="results-container">
                        <div class="results-tabs">
                            <button class="tab-button active" data-tab="agent-summary-tab">Summary</button>
                            <button class="tab-button" data-tab="agent-pageload-tab">Page Load</button>
                            <button class="tab-button" data-tab="agent-interactions-tab">Interactions</button>
                            <button class="tab-button" data-tab="agent-raw-tab">Raw JSON</button>
                            </div>

                        <div class="tab-content">
                            <div id="agent-summary-tab" class="tab-pane active">
                                <div class="section-header">
                                    <i class="fas fa-chart-bar"></i> Analysis Summary
                                </div>
                                <div id="agent-summary-content">
                                    <p>Loading summary...</p>
                                </div>
                            </div>
                            <div id="agent-pageload-tab" class="tab-pane">
                                <div class="section-header">
                                    <i class="fas fa-truck-loading"></i> Page Load Analysis
                                </div>
                                <div id="agent-pageload-content">
                                    <p>Loading page load data...</p>
                                </div>
                            </div>
                            <div id="agent-interactions-tab" class="tab-pane">
                                <div class="section-header">
                                    <i class="fas fa-mouse-pointer"></i> Agent Interactions Analysis
                                </div>
                                <div id="agent-interactions-content">
                                     <p>Loading interaction data...</p>
                                </div>
                            </div>
                             <div id="agent-raw-tab" class="tab-pane">
                                <div class="section-header">
                                    <i class="fas fa-code"></i> Raw JSON Output
                                </div>
                                <pre id="agent-raw-json-content" style="max-height: 500px; overflow: auto;"></pre> </div>
                        </div>
                    </div>
                     <div class="results-empty-state" style="display: none;">
                         <p>No analysis results available yet. Run Phase 2 analysis.</p>
                     </div>
                </div>
            </div>
        </section>

        <footer class="app-footer">
            <p>&copy; 2025 Webspark Tag Analyzer | All rights reserved</p>
        </footer>
    </div>

    <div id="notification-agent" class="notification" style="display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #28a745; color: white; padding: 10px 20px; border-radius: 5px; z-index: 1000;">
        <div class="notification-icon"><i class="fas fa-check-circle"></i></div>
        <div class="notification-content">Copied raw JSON to clipboard!</div>
    </div>

    <script>
        let targetUrl = null; // Variable to store the URL for Phase 2
        let analysisEventSource = null;
        let agentEventSource = null;

        // --- Element References ---
        const taskPromptInput = document.getElementById('taskPrompt');
        const runAgentBtn = document.getElementById('runAgentBtn');
        const agentStatusDiv = document.getElementById('agentStatus');
        const agentLogsCard = document.getElementById('agentLogsCard');
        const agentLogsContent = document.getElementById('agentLogsContent');

        const agentResultsSection = document.getElementById('agentResultsSection');
        const extractedSelectorsCard = document.getElementById('extractedSelectorsCard');
        const selectorsContentDiv = document.getElementById('selectorsContent');

        const analysisTriggerSection = document.getElementById('analysisTriggerSection');
        const analysisTargetUrlSpan = document.getElementById('analysisTargetUrl');
        const runAnalysisBtn = document.getElementById('runAnalysisBtn');

        const analysisResultsSection = document.getElementById('analysisResultsSection');
        const analysisStatusCard = document.getElementById('analysisStatusCard');
        const analysisStatusDiv = document.getElementById('analysisStatus');
        const analysisResultsCard = document.getElementById('analysisResultsCard');

        // References for the tabbed results structure
        const resultsContainerAgent = document.getElementById('results-container-agent');
        const agentSummaryContent = document.getElementById('agent-summary-content');
        const agentPageloadContent = document.getElementById('agent-pageload-content');
        const agentInteractionsContent = document.getElementById('agent-interactions-content');
        const agentRawJsonContent = document.getElementById('agent-raw-json-content');

        const copyResultsBtnAgent = document.getElementById('copy-results-agent');
        const notificationAgent = document.getElementById('notification-agent');

        let rawAnalysisResultsData = null; // To store raw JSON for copying


        // --- Phase 1: Agent Execution --- (Function remains the same as previous version)
        runAgentBtn.addEventListener('click', runAgent);

        async function runAgent() {
            const task = taskPromptInput.value.trim();
            if (!task) {
                agentStatusDiv.innerHTML = '<p class="error">Please enter an agent task.</p>';
                return;
            }
            agentStatusDiv.innerHTML = '<p>Agent running... <i class="fas fa-spinner fa-spin"></i></p>';
            agentLogsCard.style.display = 'block';
            agentLogsContent.innerHTML = 'Agent running... receiving logs...\n';
            agentResultsSection.style.display = 'none';
            extractedSelectorsCard.style.display = 'none';
            selectorsContentDiv.innerHTML = '';
            analysisTriggerSection.style.display = 'none';
            analysisTargetUrlSpan.textContent = '';
            runAnalysisBtn.disabled = true;
            analysisResultsSection.style.display = 'none';
            analysisStatusDiv.innerHTML = '';
            analysisResultsCard.style.display = 'none';
            agentSummaryContent.innerHTML = '<p>Analysis not yet run.</p>';
            agentPageloadContent.innerHTML = '<p>Analysis not yet run.</p>';
            agentInteractionsContent.innerHTML = '<p>Analysis not yet run.</p>';
            agentRawJsonContent.textContent = '';
            targetUrl = null;
            rawAnalysisResultsData = null;
            if (agentEventSource) { agentEventSource.close(); agentEventSource = null; }
            if (analysisEventSource) { analysisEventSource.close(); analysisEventSource = null; }
            runAgentBtn.disabled = true;
            taskPromptInput.disabled = true;
            try {
                const response = await fetch('/stream-agent-run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ task: task })
                });
                if (!response.ok) throw new Error(`Server error: ${response.status}`);
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    buffer += decoder.decode(value, { stream: true });
                    let dataIndex;
                    while ((dataIndex = buffer.indexOf('data: ')) >= 0) {
                        const messageEnd = buffer.indexOf('\n\n', dataIndex);
                        if (messageEnd === -1) break;
                        const jsonStr = buffer.substring(dataIndex + 6, messageEnd).trim();
                        buffer = buffer.substring(messageEnd + 2);
                        try {
                            const data = JSON.parse(jsonStr);
                            console.log('Agent Stream Received:', data);
                            if (data.status === 'log') {
                                agentLogsContent.innerHTML += `${data.message}\n`;
                                agentLogsContent.scrollTop = agentLogsContent.scrollHeight;
                            } else if (data.status === 'complete') {
                                agentLogsContent.innerHTML += `\nAgent execution complete.\n`;
                                agentStatusDiv.innerHTML = '<p style="color: green;">Agent run complete.</p>';
                                const result = data.result;
                                agentResultsSection.style.display = 'block';
                                renderSelectors(result.extracted_selectors);
                                extractedSelectorsCard.style.display = 'block';
                                targetUrl = null;
                                if (result.history && result.history.length > 0) {
                                    const lastStep = result.history[result.history.length - 1];
                                    if (lastStep.state && lastStep.state.url && lastStep.state.url !== 'about:blank') {
                                        targetUrl = lastStep.state.url;
                                    } else {
                                        for (const entry of result.history) {
                                            if (entry.state && entry.state.url && entry.state.url !== 'about:blank') {
                                                targetUrl = entry.state.url;
                                                break;
                                            }
                                        }
                                    }
                                }
                                if (targetUrl) {
                                    analysisTargetUrlSpan.textContent = targetUrl;
                                    analysisTriggerSection.style.display = 'block';
                                    runAnalysisBtn.disabled = false;
                                    agentStatusDiv.innerHTML += `<p style="color: #4c8bf5; font-weight: bold;">âœ… Ready for Phase 2: Click the 'Analyze Discovered Interactions' button below.</p>`;
                                    setTimeout(() => analysisTriggerSection.scrollIntoView({ behavior: 'smooth' }), 500);
                                } else {
                                    agentStatusDiv.innerHTML += '<p>No target URL found in history for Phase 2 analysis.</p>';
                                    analysisTriggerSection.style.display = 'none';
                                }
                                break;
                            } else if (data.status === 'error') {
                                agentLogsContent.innerHTML += `\nERROR: ${data.message}\n`;
                                agentStatusDiv.innerHTML = `<p class="error">Agent Error: ${data.message}</p>`;
                                break;
                            }
                        } catch (e) {
                            console.error('Error parsing agent message:', e, 'Raw JSON:', jsonStr);
                            agentLogsContent.innerHTML += `\nError parsing message: ${e.message}\n`;
                        }
                    }
                }
            } catch (error) {
                console.error('Error running agent:', error);
                agentLogsContent.innerHTML += `\nERROR: ${error.message}\n`;
                agentStatusDiv.innerHTML = `<p class="error">Error during agent run: ${error.message}</p>`;
            } finally {
                runAgentBtn.disabled = false;
                taskPromptInput.disabled = false;
                agentEventSource = null;
            }
        }

        // --- renderSelectors function remains the same ---
        function renderSelectors(selectors) {
            if (!selectors || selectors.length === 0) {
                 fetch('/ai_discovered_selectors.json')
                    .then(response => response.ok ? response.json() : Promise.reject('Failed to load selectors'))
                    .then(data => {
                        if (data && data.length > 0) {
                            displaySelectors(data);
                        } else {
                            selectorsContentDiv.innerHTML = '<p class="no-selectors-message">No selectors found.</p>';
                        }
                         extractedSelectorsCard.style.display = 'block';
                    })
                    .catch(error => {
                        console.error('Error loading selectors:', error);
                        selectorsContentDiv.innerHTML = '<p class="no-selectors-message">No selectors were extracted or found.</p>';
                        extractedSelectorsCard.style.display = 'block';
                    });
            } else {
                displaySelectors(selectors);
                 extractedSelectorsCard.style.display = 'block';
            }

            function displaySelectors(selectorList) {
                let html = '<ul class="selector-list">';
                selectorList.forEach(sel => {
                    html += `<li class="selector-item">
                                <span class="selector-desc">${sel.description || 'Unnamed Selector'}</span>
                                <span class="selector-code">${sel.selector}</span>
                                <span class="selector-url">URL: ${sel.url || 'N/A'}</span>
                             </li>`;
                });
                html += '</ul>';
                selectorsContentDiv.innerHTML = html;
            }
        }


        // --- Phase 2: Agentic Analysis --- (Function remains the same)
        runAnalysisBtn.addEventListener('click', runAnalysis);

        function runAnalysis() {
            if (!targetUrl) {
                alert('Error: Target URL not set. Run the agent first.');
                return;
            }
            if (analysisEventSource) { analysisEventSource.close(); }
            runAnalysisBtn.disabled = true;
            analysisResultsSection.style.display = 'block';
            analysisStatusCard.style.display = 'block';
            analysisStatusDiv.innerHTML = '<p class="status-message info">Starting analysis... <i class="fas fa-spinner fa-spin"></i></p>';
            analysisResultsCard.style.display = 'none';
            agentSummaryContent.innerHTML = '<p>Starting analysis...</p>';
            agentPageloadContent.innerHTML = '<p>Starting analysis...</p>';
            agentInteractionsContent.innerHTML = '<p>Starting analysis...</p>';
            agentRawJsonContent.textContent = '';
            rawAnalysisResultsData = null;
            let analysisUrlTarget = targetUrl;
            if (!analysisUrlTarget.startsWith('http')) {
                analysisUrlTarget = 'https://' + analysisUrlTarget;
            }
            const analysisUrlEndpoint = `/stream-agent-analysis?url=${encodeURIComponent(analysisUrlTarget)}`;
            analysisEventSource = new EventSource(analysisUrlEndpoint);
            agentStatusDiv.innerHTML += '<p style="color: #4c8bf5;">Phase 2 analysis has started! See results below.</p>';
            analysisEventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    console.log('Analysis SSE Received:', data);
                    if (data.status === 'progress') {
                        analysisStatusDiv.innerHTML += `<p class="status-message info">${data.message}</p>`;
                    } else if (data.status === 'complete') {
                        analysisStatusDiv.innerHTML += '<p class="status-message info" style="color: #4ade80; background-color: rgba(74, 222, 128, 0.1); border-color: #4ade80;">Analysis complete.</p>';
                        rawAnalysisResultsData = data.results;
                        renderAnalysisResults(data.results); // Call the updated rendering function
                        analysisResultsCard.style.display = 'block';
                        activateTabLogic();
                        analysisEventSource.close();
                        analysisEventSource = null;
                        setTimeout(() => {
                             analysisResultsCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                         }, 100);
                    } else if (data.status === 'error') {
                         analysisStatusDiv.innerHTML += `<p class="status-message error">Analysis Error: ${data.message}</p>`;
                         analysisEventSource.close();
                         analysisEventSource = null;
                         runAnalysisBtn.disabled = false;
                    }
                } catch (e) {
                    console.error("Error parsing analysis SSE data:", e, "Raw data:", event.data);
                    analysisStatusDiv.innerHTML += `<p class="status-message error">Error processing update: ${e.message}</p>`;
                }
            };
            analysisEventSource.onerror = function(error) {
                console.error('Analysis SSE Error:', error);
                analysisStatusDiv.innerHTML += '<p class="status-message error">Connection error during analysis.</p>';
                if (analysisEventSource) analysisEventSource.close();
                analysisEventSource = null;
                runAnalysisBtn.disabled = false;
            };
        }

        // --- *** UPDATED renderAnalysisResults function *** ---
        function renderAnalysisResults(results) {
            // Clear previous content
            agentSummaryContent.innerHTML = '';
            agentPageloadContent.innerHTML = '';
            agentInteractionsContent.innerHTML = '';
            agentRawJsonContent.textContent = '';

            if (!results) {
                agentSummaryContent.innerHTML = '<p style="color: #f87171;">No analysis results received.</p>';
                agentRawJsonContent.textContent = 'N/A';
                // Hide the container if no results, show empty state
                resultsContainerAgent.style.display = 'none';
                document.querySelector('#analysisResultsCard .results-empty-state').style.display = 'block';
                return;
            }

            // Ensure results container is visible and empty state is hidden
             resultsContainerAgent.style.display = 'block';
             document.querySelector('#analysisResultsCard .results-empty-state').style.display = 'none';

            // --- Populate Raw JSON Tab ---
            try {
                agentRawJsonContent.textContent = JSON.stringify(results, null, 2);
                rawAnalysisResultsData = results; // Store for copy button
            } catch (e) {
                agentRawJsonContent.textContent = `Error stringifying results: ${e.message}`;
                rawAnalysisResultsData = null;
            }


            // --- Populate Summary Tab ---
            let summaryHtml = `<p><strong>Analyzed URL:</strong> ${results.url || 'N/A'}</p>`;
            summaryHtml += `<p><strong>Page Title:</strong> ${results.page_title || 'N/A'}</p>`;

            // Display overall analysis error, if any
            if (results.error && results.error !== null) {
                 summaryHtml += `<p style="color: #f87171;"><strong>Analysis Error:</strong> ${results.error}</p>`;
            }

            // Safely access nested properties
            const pl = results.pageLoadAnalysis || {}; // Default to empty object if missing
            const ai = results.agentInteractionAnalysis || []; // Default to empty array if missing

            // Vendor count from top-level key
            let vendorCount = 0;
            if (results.vendors_on_page && typeof results.vendors_on_page === 'object') {
                 vendorCount = Object.values(results.vendors_on_page)
                                   .filter(list => Array.isArray(list)) // Ensure it's an array
                                   .reduce((count, list) => count + list.length, 0);
            }
            summaryHtml += `<p><strong>Vendors Detected (Page Load):</strong> ${vendorCount}</p>`;

            // Initial Tealium Events count
            const initialTealiumEventsCount = (pl.initial_tealium_events && Array.isArray(pl.initial_tealium_events)) ? pl.initial_tealium_events.length : 0;
            summaryHtml += `<p><strong>Initial Tealium Events:</strong> ${initialTealiumEventsCount}</p>`;

            // Agent Interactions Summary
            const agentInteractionsCount = Array.isArray(ai) ? ai.length : 0;
            summaryHtml += `<p><strong>Agent Interactions Analyzed:</strong> ${agentInteractionsCount}</p>`;

            if (agentInteractionsCount > 0) {
                const successfulInteractions = ai.filter(i => i && i.status === 'Success').length;
                const failedInteractions = agentInteractionsCount - successfulInteractions;
                summaryHtml += `<p><strong>Successful Interactions:</strong> <span style="color: #4ade80;">${successfulInteractions}</span></p>`;
                if (failedInteractions > 0) {
                     summaryHtml += `<p><strong>Failed Interactions:</strong> <span style="color: #f87171;">${failedInteractions}</span></p>`;
                }
            }
            agentSummaryContent.innerHTML = summaryHtml;


            // --- Populate Page Load Tab ---
            let pageLoadHtml = '';

            // Vendors from 'pageLoadAnalysis.vendors_on_page'
            if (pl && pl.vendors_on_page && typeof pl.vendors_on_page === 'object' && Object.keys(pl.vendors_on_page).length > 0) {
                pageLoadHtml += `<h6 style="color: #4c8bf5;">Vendors Detected on Page:</h6>`;
                let vendorsFound = false;
                for (const category in pl.vendors_on_page) {
                    const vendorList = pl.vendors_on_page[category];
                    if (vendorList && Array.isArray(vendorList) && vendorList.length > 0) {
                        vendorsFound = true;
                        pageLoadHtml += `<h7 class="vendor-category">${category.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}:</h7>`; // Format category name
                        pageLoadHtml += `<ul class="vendor-list">`;
                        vendorList.forEach(vendor => {
                            pageLoadHtml += `<li>${vendor || 'N/A'}</li>`; // Handle potential null/empty vendor names
                        });
                        pageLoadHtml += `</ul>`;
                    }
                }
                 if (!vendorsFound) {
                     pageLoadHtml += `<p>No vendors listed under categories.</p>`;
                 }
            } else {
                pageLoadHtml += `<p>No vendors detected via 'pageLoadAnalysis.vendors_on_page' key or key is not an object.</p>`;
            }

             // Populate Utag Data Table
             if (pl && pl.utag_data && typeof pl.utag_data === 'object') {
                 const utagData = pl.utag_data;
                 const utagKeys = Object.keys(utagData).sort(); // Sort keys alphabetically
                 if (utagKeys.length > 0) {
                     pageLoadHtml += `<h6 style="color: #4c8bf5; margin-top: 20px;">Utag Data Variables (${utagKeys.length}):</h6>`;
                     pageLoadHtml += `<div style="max-height: 400px; overflow-y: auto;">
                                      <table class="event-table" id="agent-utag-data-table">
                                          <thead><tr><th>Data Key</th><th>Value</th></tr></thead>
                                          <tbody>`;
                     utagKeys.forEach(key => {
                         let value = utagData[key];
                         let displayValue;
                         try {
                             // Attempt to stringify objects/arrays for display
                             if (typeof value === 'object' && value !== null) {
                                 displayValue = JSON.stringify(value);
                             } else if (value === undefined) {
                                 displayValue = '<em>undefined</em>';
                             } else if (value === null) {
                                 displayValue = '<em>null</em>';
                             } else {
                                 displayValue = String(value); // Convert others to string
                             }
                         } catch (e) {
                             displayValue = '[Error Displaying Value]'; // Handle stringify errors
                         }

                         // Escape HTML to prevent XSS
                         const escapedKey = key.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                         const escapedValue = displayValue.replace(/</g, "&lt;").replace(/>/g, "&gt;");

                         pageLoadHtml += `<tr>
                                              <td><code>${escapedKey}</code></td>
                                              <td style="word-break: break-all;">${escapedValue}</td>
                                           </tr>`;
                     });
                     pageLoadHtml += `</tbody></table></div>`;
                 } else {
                     pageLoadHtml += `<p style="margin-top: 15px;">Utag data object is empty.</p>`;
                 }
             } else {
                 pageLoadHtml += `<p style="margin-top: 15px;">Utag data not found or is not an object in pageLoadAnalysis.</p>`;
             }

             agentPageloadContent.innerHTML = pageLoadHtml;


            // --- Populate Interactions Tab ---
            let interactionsHtml = '';
            if (agentInteractionsCount > 0) {
                ai.forEach((interaction, index) => {
                    if (!interaction) return; // Skip null/undefined interactions

                    interactionsHtml += `<div class="interaction-card">`;
                    interactionsHtml += `<h6>Interaction ${index + 1}: ${interaction.description || 'N/A'}</h6>`;
                    interactionsHtml += `<p><strong>Selector:</strong> <code>${interaction.selector || 'N/A'}</code></p>`;
                    const statusText = interaction.status || 'Unknown';
                    const statusColor = statusText === 'Success' ? '#4ade80' : (statusText.startsWith('Failure') ? '#f87171' : '#e6edf3'); // Default color for Pending/Skipped
                    interactionsHtml += `<p><strong>Status:</strong> <span style="color: ${statusColor};">${statusText}</span></p>`;

                    if (interaction.error && interaction.error !== null) {
                         interactionsHtml += `<p style="color: #f87171;"><strong>Error:</strong> ${interaction.error}</p>`;
                    }

                    // Tealium Events Triggered
                    const triggeredTealiumEvents = (interaction.tealium_events && Array.isArray(interaction.tealium_events)) ? interaction.tealium_events : [];
                    if (triggeredTealiumEvents.length > 0) {
                         interactionsHtml += `<h6 style="color: #4c8bf5;">Triggered Tealium Events (${triggeredTealiumEvents.length}):</h6>`;
                         try {
                             interactionsHtml += `<pre>${JSON.stringify(triggeredTealiumEvents, null, 2)}</pre>`;
                         } catch(e) {
                              interactionsHtml += `<pre>Error displaying Tealium events: ${e.message}</pre>`;
                         }
                    } else if (statusText === 'Success') { // Only show 'No events' if the interaction succeeded
                         interactionsHtml += `<p>No Tealium events triggered by this interaction.</p>`;
                    }

                    // Vendors Called After Interaction
                    const vendorsInNetwork = interaction.vendors_in_network || {};
                    const vendorKeys = Object.keys(vendorsInNetwork);
                    if (vendorKeys.length > 0 && vendorsInNetwork.error === undefined) { // Check it's not just the error object
                          interactionsHtml += `<h6 style="color: #4c8bf5;">Vendors Called After Interaction (${vendorKeys.length}):</h6><ul class="vendor-list" style="margin-left: 0; list-style-position: inside;">`; // Use vendor-list class
                          vendorKeys.forEach(v => { interactionsHtml += `<li>${v}</li>`; });
                          interactionsHtml += `</ul>`;
                    } else if (vendorsInNetwork.error) {
                         interactionsHtml += `<p><em style="opacity: 0.8;">Vendor network analysis error: ${vendorsInNetwork.error}</em></p>`;
                    }

                    // Network Events After Interaction
                    const postInteractionNetwork = (interaction.general_events && Array.isArray(interaction.general_events.network)) ? interaction.general_events.network : [];
                    if (postInteractionNetwork.length > 0) {
                          interactionsHtml += `<h6 style="color: #4c8bf5;">Network Events After Interaction (${postInteractionNetwork.length}):</h6>`;
                          interactionsHtml += `<div style="max-height: 200px; overflow-y: auto;">
                                              <table class="event-table">
                                                  <thead><tr><th>URL</th><th>Method</th><th>Type</th><th>Time</th></tr></thead>
                                                  <tbody>`;
                          postInteractionNetwork.forEach(n => {
                               if (!n) return; // Skip null/undefined
                               const timestamp = n.timestamp ? new Date(n.timestamp).toLocaleTimeString() : 'N/A';
                               interactionsHtml += `<tr>
                                                     <td style="word-break: break-all; font-size: 0.9em;">${n.url || 'N/A'}</td>
                                                     <td>${n.method || 'N/A'}</td>
                                                     <td>${n.type || 'N/A'}</td>
                                                     <td>${timestamp}</td>
                                                  </tr>`;
                          });
                          interactionsHtml += `</tbody></table></div>`;
                    } else if (statusText === 'Success') {
                        interactionsHtml += `<p style="font-size: 0.9em; opacity: 0.8;">No network events captured after this interaction.</p>`;
                    }
                    interactionsHtml += `</div>`; // Close interaction-card
                });
            } else {
                interactionsHtml = '<p>No agent interactions were analyzed or recorded.</p>';
            }
            agentInteractionsContent.innerHTML = interactionsHtml;

            // Ensure the default active tab (Summary) is displayed correctly after rendering
            activateTabLogic(); // Re-activate logic in case it wasn't called yet
            const summaryTabButton = document.querySelector('.tab-button[data-tab="agent-summary-tab"]');
            const summaryPane = document.getElementById('agent-summary-tab');
            if (summaryTabButton && summaryPane && !summaryTabButton.classList.contains('active')) {
                // If summary isn't active, make it active (or whichever should be default)
                 document.querySelectorAll('#results-container-agent .tab-button').forEach(btn => btn.classList.remove('active'));
                 document.querySelectorAll('#results-container-agent .tab-pane').forEach(pane => {
                     pane.classList.remove('active');
                     pane.style.display = 'none';
                 });
                 summaryTabButton.classList.add('active');
                 summaryPane.classList.add('active');
                 summaryPane.style.display = 'block';
            } else if (summaryPane && summaryPane.classList.contains('active')) {
                // If summary is already active, ensure it's displayed
                 summaryPane.style.display = 'block';
            }
        }

        // --- Tab Switching Logic --- (Remains the same)
        function activateTabLogic() {
            const tabsContainer = document.querySelector('#results-container-agent .results-tabs');
            const tabButtons = tabsContainer ? tabsContainer.querySelectorAll('.tab-button') : [];
            const tabPanes = resultsContainerAgent.querySelectorAll('.tab-pane');
            if (!tabsContainer) return;
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabPanes.forEach(pane => {
                        pane.classList.remove('active');
                        pane.style.display = 'none';
                    });
                    button.classList.add('active');
                    const targetTabId = button.getAttribute('data-tab');
                    const targetPane = document.getElementById(targetTabId);
                    if (targetPane) {
                        targetPane.classList.add('active');
                        targetPane.style.display = 'block';
                    }
                });
            });
             // Ensure the initially active tab is displayed on first load
             const initiallyActiveButton = tabsContainer.querySelector('.tab-button.active');
             if (initiallyActiveButton) {
                 const initialTabId = initiallyActiveButton.getAttribute('data-tab');
                 const initialPane = document.getElementById(initialTabId);
                 if (initialPane) {
                     initialPane.classList.add('active');
                     initialPane.style.display = 'block';
                 }
             }
        }
        activateTabLogic(); // Call once on load

         // --- Copy Results Logic --- (Remains the same)
         if (copyResultsBtnAgent) {
            copyResultsBtnAgent.addEventListener('click', () => {
                if (rawAnalysisResultsData) {
                    navigator.clipboard.writeText(JSON.stringify(rawAnalysisResultsData, null, 2))
                        .then(() => {
                            notificationAgent.style.display = 'block';
                            setTimeout(() => {
                                notificationAgent.style.display = 'none';
                            }, 2000);
                        })
                        .catch(err => {
                            console.error('Failed to copy results: ', err);
                            alert('Failed to copy results.');
                        });
                } else {
                    alert('No results data available to copy.');
                }
            });
        }

        // --- Theme Toggle Logic --- (Remains the same)
        const themeToggle = document.querySelector('.theme-toggle');
        if (themeToggle) {
            themeToggle.addEventListener('click', () => {
                document.body.classList.toggle('dark-theme');
                localStorage.setItem('theme', document.body.classList.contains('dark-theme') ? 'dark' : 'light');
            });
        }
        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-theme');
        }

    </script>
</body>
</html>